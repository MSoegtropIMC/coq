#!/usr/bin/env bash

# Run in a proper install dune env.
case $1 in
    checker)
        shift
        exe=_build/default/checker/coqchk.bc
        ;;
    coqide)
        exe=_build/default/ide/coqide_main.bc
        ;;
    *)
        exe=_build/default/topbin/coqc_bin.bc
        ;;
esac

emacs="${INSIDE_EMACS:+-emacs}"

# Note: when doing a local dune build, ocamlfind won't work unless you do
# export OCAMLPATH=<coq_root>/_build/install/default/lib
# dune exports this automatically to child processes (e.g. this script).

list_coq_packages="$(ocamlfind list | sed 's/ *(.*)//' | grep '^coq')"
list_coq_include_args=$(ocamlfind query -recursive -i-format $list_coq_packages | sort | uniq)

ocamldebug $emacs $list_coq_include_args -I +threads -I dev $exe "$@"
